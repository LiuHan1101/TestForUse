<!-- pages/me/profile/profile.wxml -->
<view class="profile-container">
  <!-- 主加载状态 -->
  <view class="loading-state" wx:if="{{isLoading}}">
    <view class="loading-content">
      <image src="/images/loading.gif" class="loading-icon"></image>
      <text>加载用户信息...</text>
    </view>
  </view>

  <view wx:else>
    <!-- 头部用户信息模块 -->
    <view class="header-section card">
      <view class="user-basic-info">
        <!-- 头像，添加错误处理 -->
        <image 
          class="user-avatar" 
          src="{{userInfo.avatar}}" 
          mode="aspectFill"
          binderror="onImageError"
          data-type="avatar">
        </image>
        <view class="user-text-info">
          <view class="user-nickname">{{userInfo.nickname}}</view>
          <view class="user-college">{{userInfo.college || '未设置学院'}}</view>
          <view class="user-stats">
            <text class="stat-item">加入 {{userInfo.joinDays}} 天</text>
            <text class="stat-item">信用 {{userInfo.creditScore}}</text>
          </view>
        </view>
      </view>
      
      <!-- 根据是否查看他人显示不同按钮 -->
      <button 
        class="action-btn message-btn" 
        bindtap="onSendMessage" 
        wx:if="{{isViewOtherUser}}">
        私信
      </button>
      <button 
        class="action-btn edit-btn" 
        bindtap="onEditProfile" 
        wx:else>
        编辑资料
      </button>
    </view>

    <!-- 评价模块 -->
    <view class="rating-section card" wx:if="{{!isViewOtherUser || commentCount > 0}}">
      <view class="rating-title">用户评价</view>
      <view class="rating-content">
        <!-- 左边评论滚动区域 -->
        <view class="comment-scroll" wx:if="{{comments.length > 0}}">
          <scroll-view class="comment-list" scroll-y>
            <view class="comment-item" wx:for="{{comments}}" wx:key="id">
              <text class="comment-user">{{item.user}}:</text>
              <text class="comment-text">{{item.content}}</text>
            </view>
          </scroll-view>
        </view>
        <view class="comment-empty" wx:else>
          <text>暂无评价</text>
        </view>
        <!-- 右边评分区域 -->
        <view class="score-display">
          <view class="score-number">{{ratingScore}}</view>
          <view class="score-total">/5分</view>
          <view class="rating-stars">
            <!-- 根据实际评分显示星星 -->
            <text class="star active" wx:for="{{5}}" wx:key="*this" wx:if="{{index < Math.floor(ratingScore)}}">★</text>
            <text class="star" wx:for="{{5}}" wx:key="*this" wx:if="{{index >= Math.floor(ratingScore)}}">☆</text>
          </view>
          <view class="rating-count">{{commentCount}}条评价</view>
        </view>
      </view>
    </view>

    <!-- 个人简介模块 -->
    <view class="bio-section card">
      <view class="section-title">个人简介</view>
      <view class="bio-content">{{userInfo.bio || '暂无简介'}}</view>
      <view class="tags-section">
        <view class="tags-title">个性标签</view>
        <view class="tags-list">
          <text class="tag" wx:for="{{userInfo.tags}}" wx:key="*this">{{item}}</text>
          <text class="tag add-tag" bindtap="onAddTag" wx:if="{{!isViewOtherUser}}">+</text>
        </view>
      </view>
    </view>

    <!-- 出物和许愿信息模块 -->
    <view class="goods-section">
      <!-- 标签切换 -->
      <view class="goods-tabs">
        <view 
          class="tab {{activeGoodsTab === 'published' ? 'active' : ''}}"
          data-tab="published" 
          bindtap="switchGoodsTab">
          发布 ({{publishedGoods.length}})
        </view>
        <view 
          class="tab {{activeGoodsTab === 'wish' ? 'active' : ''}}"
          data-tab="wish" 
          bindtap="switchGoodsTab">
          许愿 ({{wishGoods.length}})
        </view>
      </view>

      <!-- 商品列表加载状态 -->
      <view class="loading-state" wx:if="{{activeGoodsTab === 'published' && isLoadingGoods}}">
        <view class="loading-content">
          <image src="/images/loading.gif" class="loading-icon"></image>
          <text>加载商品中...</text>
        </view>
      </view>

      <!-- 愿望列表加载状态 -->
      <view class="loading-state" wx:if="{{activeGoodsTab === 'wish' && isLoadingWishes}}">
        <view class="loading-content">
          <image src="/images/loading.gif" class="loading-icon"></image>
          <text>加载愿望中...</text>
        </view>
      </view>

      <!-- 商品/愿望列表内容 -->
      <view class="goods-list" wx:if="{{!isLoadingGoods && !isLoadingWishes}}">
        <!-- 已发布商品 -->
        <block wx:if="{{activeGoodsTab === 'published'}}">
          <!-- 空状态 -->
          <view class="empty-state" wx:if="{{showEmptyGoods || publishedGoods.length === 0}}">
            <image src="/images/empty-goods.png" class="empty-icon"></image>
            <text class="empty-text">还没有发布商品哦～</text>
          </view>
          
          <!-- 商品列表 -->
          <view 
            class="goods-item" 
            wx:for="{{publishedGoods}}" 
            wx:key="id" 
            data-id="{{item.id}}" 
            data-index="{{index}}"
            bindtap="onGoodsTap">
            <image 
              class="goods-image" 
              src="{{item.image}}" 
              mode="aspectFill" 
              data-index="{{index}}" 
              binderror="onImageError"
              data-type="goods">
            </image>
            <view class="goods-info">
              <view class="goods-title">{{item.title}}</view>
              <view class="goods-price">
                <text class="price" wx:if="{{item.price > 0}}">¥{{item.price}}</text>
                <text class="swap-tag" wx:if="{{item.transactionType === 'swap'}}">可换物</text>
                <text class="both-tag" wx:if="{{item.transactionType === 'both'}}">可买可换</text>
                <text class="status-tag {{item.status}}" wx:if="{{item.status !== 'selling'}}">{{item.status === 'sold' ? '已售出' : '已下架'}}</text>
              </view>
              <view class="goods-desc">{{item.description}}</view>
            </view>
          </view>
        </block>

        <!-- 许愿列表 -->
        <block wx:if="{{activeGoodsTab === 'wish'}}">
          <!-- 空状态 -->
          <view class="empty-state" wx:if="{{showEmptyWishes || wishGoods.length === 0}}">
            <image src="/images/empty-wish.png" class="empty-icon"></image>
            <text class="empty-text">还没有许愿哦～</text>
          </view>
          
          <!-- 愿望列表 -->
          <view wx:else class="goods-list">
            <view wx:for="{{wishGoods}}" wx:key="id" 
                  class="goods-item" 
                  data-id="{{item.id}}" 
                  data-type="wish"
                  bindtap="onGoodsTap">
              <image src="{{item.image}}" 
                     class="goods-image" 
                     mode="aspectFill"
                     data-index="{{index}}"
                     data-type="wish"
                     binderror="onImageError"></image>
              <view class="goods-info">
                <text class="goods-title">{{item.title}}</text>
                <text class="goods-desc">{{item.shortDescription}}</text>
                <view class="goods-footer">
                  <text class="goods-price">{{item.transactionTypeText}}</text>
                  <text class="goods-time">{{item.createTime}}</text>
               </view>
              </view>
            </view>
          </view>
        </block>
      </view> 
    </view>
  </view>
</view>