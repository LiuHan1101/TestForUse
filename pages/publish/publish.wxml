<!--pages/publish/publish.wxml-->

<view class="publish-page">
  <!-- 表单内容 -->
  <view class="publish-content">
    <!-- 标题 -->
    <view class="form-group">
      <view class="form-label">商品标题</view>
      <input 
        class="form-input" 
        placeholder="请输入商品标题（最多30字）" 
        maxlength="30"
        value="{{formData.title}}"
        bindinput="onTitleInput"
      />
    </view>

    <!-- 描述 -->
    <view class="form-group">
      <view class="form-label">商品描述</view>
      <textarea 
        class="form-textarea" 
        placeholder="详细描述商品的状况、使用情况、瑕疵等..." 
        maxlength="500"
        value="{{formData.description}}"
        bindinput="onDescriptionInput"
      />
      <view class="char-count">{{formData.description.length}}/500</view>
    </view>

    <!-- 图片上传 -->
    <view class="form-group">
      <view class="form-label">商品图片</view>
      
      <!-- 图片上传区域 -->
      <view class="image-upload-container">
        <view class="image-upload {{formData.images.length > 0 ? 'active' : ''}}" bindtap="onShowImageAction">
          <view class="upload-icon">📷</view>
          <view class="upload-text">
            {{formData.images.length > 0 ? '继续添加图片' : '点击上传图片'}}
          </view>
          <view class="upload-hint">已上传 {{formData.images.length}}/9张</view>
          <view class="upload-options">
            <text class="option-text">支持拍照和相册选择</text>
          </view>
        </view>

        <!-- 图片预览 -->
        <view class="image-preview" wx:if="{{formData.images.length > 0}}">
          <view 
            class="preview-item" 
            wx:for="{{formData.images}}" 
            wx:key="index" 
            data-index="{{index}}"
            bindtap="onPreviewImage"
            bindtouchstart="onImageDragStart"
            bindtouchmove="onImageDragOver"
            bindtouchend="onImageDrop"
          >
            <image class="preview-image" src="{{item}}" mode="aspectFill" />
            <view class="image-order">{{index + 1}}</view>
            <view class="delete-image" catchtap="onDeleteImage" data-index="{{index}}">×</view>
          </view>
        </view>
      </view>
    </view>

<!-- pages/publish/publish.wxml -->
<!-- 分类选择（多选） -->
<view class="form-group">
  <view class="form-label">
    商品标签
    <text class="label-hint">（最多选3个）</text>
  </view>

  <!-- 已选标签显示区域 - 只在有选中标签时显示 -->
  <view class="selected-tags" wx:if="{{formData.categories.length > 0}}">
    <view class="selected-tags-list">
      <view class="selected-tag-item" wx:for="{{formData.categories}}" wx:key="*this">
        <text class="selected-tag-text">{{item}}</text>
        <text class="selected-tag-remove" data-tag="{{item}}" bindtap="removeTag">×</text>
      </view>
    </view>
  </view>
  

  <view class="category-grid">
    <!-- 固定分类标签 - 使用动态样式对象 -->
    <view 
      style="{{categoryStyles[index]}}"
      wx:for="{{categories}}"
      wx:key="name"
      data-index="{{index}}"
      data-category="{{item.label}}"
      bindtap="onCategorySelect"
    >
      <text class="category-label">{{item.label}}</text>
    </view>
    
    <!-- 添加自定义标签按钮 -->
    <view class="category-item custom-tag-add" bindtap="showCustomTagInput">
      <text class="category-icon">+</text>
      <text class="category-label">自定义</text>
    </view>
  </view>
  
  <!-- 选择数量提示 -->
  <view class="selection-hint">
    已选择 {{formData.categories.length}}/3 个标签
  </view>
</view>
    <!-- 自定义标签输入弹窗 -->
    <view wx:if="{{showCustomTagInput}}" class="custom-tag-modal">
      <view class="custom-tag-mask" bindtap="hideCustomTagInput"></view>
      <view class="custom-tag-content">
        <view class="custom-tag-header">
          <text class="custom-tag-title">添加自定义标签</text>
          <text class="custom-tag-close" bindtap="hideCustomTagInput">×</text>
        </view>
        
        <view class="custom-tag-body">
          <view class="input-container">
            <input 
              class="custom-tag-input" 
              placeholder="请输入标签内容" 
              value="{{customTagInputValue}}"
              bindinput="onCustomTagInput"
              placeholder-class="placeholder"
            />
            <view class="char-count {{customTagCharCount > 5 ? 'exceed' : ''}}">
              {{customTagCharCount}}/5
            </view>
          </view>
          <view class="custom-tag-tip">支持中英文，最终显示前5个汉字</view>
        </view>
        
        <view class="custom-tag-footer">
          <button class="custom-tag-btn cancel" bindtap="hideCustomTagInput">取消</button>
          <button class="custom-tag-btn confirm" bindtap="addCustomTag">确定</button>
        </view>
      </view>
    </view>

  <!-- 交易方式部分 -->
<view class="form-group">
  <view class="form-label">交易方式</view>
  <view class="transaction-type">
    <!-- 现金交易 -->
    <view 
      class="type-option {{formData.transactionType === 'cash' ? 'active' : ''}}"
      data-type="cash"
      bindtap="onTypeChange"
    >
      <view class="type-icon">
        <image 
          src="/images/cash.png" 
          style="width:50rpx;height:50rpx;"
          mode="aspectFit"
          class="{{formData.transactionType === 'cash' ? 'icon-active' : 'icon-inactive'}}"
        />
      </view>
      <view class="type-label">现金交易</view>
    </view>
    
    <!-- 以物换物 -->
    <view 
      class="type-option {{formData.transactionType === 'swap' ? 'active' : ''}}"
      data-type="swap"
      bindtap="onTypeChange"
    >
      <view class="type-icon">
        <image 
          src="/images/exchange.png" 
          style="width:50rpx;height:50rpx;"
          mode="aspectFit"
          class="{{formData.transactionType === 'swap' ? 'icon-active' : 'icon-inactive'}}"
        />
      </view>
      <view class="type-label">以物换物</view>
    </view>
    
    <!-- 均可 -->
    <view 
      class="type-option {{formData.transactionType === 'both' ? 'active' : ''}}"
      data-type="both"
      bindtap="onTypeChange"
    >
      <view class="type-icon">
        <image 
          src="/images/both.png" 
          style="width:50rpx;height:50rpx;"
          mode="aspectFit"
          class="{{formData.transactionType === 'both' ? 'icon-active' : 'icon-inactive'}}"
        />
      </view>
      <view class="type-label">均可</view>
    </view>
  </view>
</view>

    <!-- 发布形式：出物/许愿 -->
    <view class="form-group">
      <view class="form-label">发布形式</view>
      <view class="switch-type">
        <view 
          class="type-option {{formData.switch === 'object' ? 'active' : ''}}"
          data-type="object"
          bindtap="onFormChange"
        >
          <view class="type-label">出物</view>
        </view>
        <view 
          class="type-option {{formData.switch === 'wish' ? 'active' : ''}}"
          data-type="wish"
          bindtap="onFormChange"
        >
          <view class="type-label">许愿</view>
        </view>
      </view>
    </view>

    <!-- 价格输入 -->
    <view class="form-group" wx:if="{{formData.transactionType === 'cash' || formData.transactionType === 'both'}}">
      <view class="form-label">商品价格</view>
      <view class="price-input-wrapper">
        <text class="price-symbol">¥</text>
        <input 
          class="form-input price-input" 
          type="digit"
          placeholder="0.00"
          value="{{formData.price}}"
          bindinput="onPriceInput"
        />
      </view>
    </view>

    <!-- 期望换物 -->
    <view class="form-group" wx:if="{{formData.transactionType === 'swap' || formData.transactionType === 'both'}}">
      <view class="form-label">期望换得</view>
      <input 
        class="form-input" 
        placeholder="请输入希望换得的物品..."
        value="{{formData.expectedSwap}}"
        bindinput="onExpectedSwapInput"
      />
    </view>

    <!-- 发布按钮 -->
    <button 
      class="publish-btn" 
      bindtap="onSubmit"
      disabled="{{isSubmitting}}"
    >
      {{isSubmitting ? '发布中...' : '立即发布'}}
    </button>

    <!-- 发布提示 -->
    <view class="publish-tips" bindtap="showPublishTips">
      <text class="tips-icon">💡</text>
      <text class="tips-text">发布小贴士</text>
    </view>
  </view>

  <!-- 图片操作面板 -->
  <view class="image-action-sheet {{showImageAction ? 'show' : ''}}">
    <view class="action-mask" bindtap="onHideImageAction"></view>
    <view class="action-content">
      <view class="action-header">
        <text class="action-title">选择图片</text>
        <text class="action-close" bindtap="onHideImageAction">×</text>
      </view>
      <view class="action-buttons">
        <view class="action-btn take-photo" bindtap="onTakePhoto">
          <view class="btn-icon">📸</view>
          <view class="btn-text">拍照</view>
        </view>
        <view class="action-btn choose-album" bindtap="onChooseFromAlbum">
          <view class="btn-icon">🖼️</view>
          <view class="btn-text">从相册选择</view>
        </view>
      </view>
    </view>
  </view>
</view>

